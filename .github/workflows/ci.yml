# =============================================================================
# ScamAware Jersey - Continuous Integration Workflow
# =============================================================================
#
# This workflow runs on every push to main and on pull requests targeting main.
# It performs linting, type checking, testing, and Docker image builds to ensure
# code quality and build integrity.
#
# Jobs:
#   1. lint       - Runs ESLint (frontend) and Ruff (guardrails)
#   2. typecheck  - Runs TypeScript compiler and mypy
#   3. test       - Runs frontend and backend test suites
#   4. build      - Builds Docker images (depends on lint & typecheck passing)
#
# =============================================================================

name: CI

# -----------------------------------------------------------------------------
# Workflow Triggers
# -----------------------------------------------------------------------------
# Runs on pushes to main branch and pull requests targeting main branch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# -----------------------------------------------------------------------------
# Concurrency Settings
# -----------------------------------------------------------------------------
# Cancel in-progress runs for the same branch to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# Jobs
# =============================================================================

jobs:
  # ---------------------------------------------------------------------------
  # Lint Job
  # ---------------------------------------------------------------------------
  # Runs code linting for both frontend (ESLint) and guardrails (Ruff)
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Node.js environment for frontend linting
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Set up Python environment for guardrails linting
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: guardrails/pyproject.toml

      # Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # Install guardrails development dependencies (includes Ruff)
      - name: Install guardrails dependencies
        working-directory: guardrails
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      # Run ESLint on frontend TypeScript/JavaScript code
      - name: Run ESLint (frontend)
        working-directory: frontend
        run: npm run lint

      # Run Ruff linter on guardrails Python code
      - name: Run Ruff (guardrails)
        working-directory: guardrails
        run: ruff check .

  # ---------------------------------------------------------------------------
  # Type Check Job
  # ---------------------------------------------------------------------------
  # Runs static type checking for both frontend (TypeScript) and guardrails (mypy)
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Node.js environment for TypeScript checking
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Set up Python environment for mypy type checking
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: guardrails/pyproject.toml

      # Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # Install guardrails development dependencies (includes mypy)
      - name: Install guardrails dependencies
        working-directory: guardrails
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      # Run TypeScript compiler in check mode (no emit)
      - name: Run TypeScript type check (frontend)
        working-directory: frontend
        run: npm run typecheck

      # Run mypy static type checker on guardrails Python code
      - name: Run mypy (guardrails)
        working-directory: guardrails
        run: mypy . --ignore-missing-imports
        # Note: --ignore-missing-imports handles third-party libraries without type stubs

  # ---------------------------------------------------------------------------
  # Test Job
  # ---------------------------------------------------------------------------
  # Runs test suites for both frontend and guardrails
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Node.js environment for frontend tests
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      # Set up Python environment for guardrails tests
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: guardrails/pyproject.toml

      # Install frontend dependencies
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      # Install guardrails development dependencies (includes pytest)
      - name: Install guardrails dependencies
        working-directory: guardrails
        run: |
          python -m pip install --upgrade pip
          pip install ".[dev]"

      # Run frontend tests (allow failure initially as tests may not exist yet)
      - name: Run frontend tests
        working-directory: frontend
        run: npm test --if-present
        continue-on-error: true
        # Note: --if-present skips if no test script exists
        # continue-on-error allows the job to pass even if tests fail initially

      # Run guardrails tests with pytest (allow failure if no tests exist yet)
      - name: Run guardrails tests (pytest)
        working-directory: guardrails
        run: |
          if [ -d "tests" ] && [ "$(ls -A tests/*.py 2>/dev/null)" ]; then
            pytest tests/ -v --tb=short
          else
            echo "No tests found in guardrails/tests directory - skipping"
          fi
        continue-on-error: true
        # Note: Checks for tests directory and .py files before running pytest

  # ---------------------------------------------------------------------------
  # Build Job
  # ---------------------------------------------------------------------------
  # Builds Docker images for both services (does not push)
  # Only runs after lint and typecheck jobs pass
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, typecheck]
    # This job depends on lint and typecheck passing first

    steps:
      # Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Set up Docker Buildx for improved build capabilities
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build frontend Docker image (no push - just verify it builds)
      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: scamaware-jersey/frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        # Note: Uses GitHub Actions cache for faster subsequent builds

      # Build guardrails Docker image (no push - just verify it builds)
      - name: Build guardrails Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./guardrails
          file: ./guardrails/Dockerfile
          push: false
          tags: scamaware-jersey/guardrails:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        # Note: Uses GitHub Actions cache for faster subsequent builds
